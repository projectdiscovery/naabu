package probes

// embeddedProbe defines a probe with its name, payload, rarity, and target ports.
type embeddedProbe struct {
	name    string
	rarity  int // 1-9, lower = more common (matches nmap)
	payload []byte
	ports   []int
}

// embeddedProbes contains all built-in UDP service probes.
// Probes are sorted by rarity when loaded (lower rarity = tried first).
// Probe sources: nmap-service-probes (https://github.com/nmap/nmap)
var embeddedProbes = []embeddedProbe{
	// DNS (53) - Domain Name System
	{
		name:   "DNSVersionBindReq",
		rarity: 2,
		// version.bind TXT CH query - fingerprints DNS servers
		payload: []byte{
			0x00, 0x06, 0x01, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x07, 0x76, 0x65, 0x72, 0x73, 0x69, 0x6f, 0x6e, 0x04, 0x62, 0x69, 0x6e,
			0x64, 0x00, 0x00, 0x10, 0x00, 0x03,
		},
		ports: []int{53},
	},
	{
		name:   "DNSStatusRequest",
		rarity: 3,
		// Minimal DNS status query
		payload: []byte{
			0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		},
		ports: []int{53, 5353},
	},

	// TFTP (69) - Trivial File Transfer Protocol
	{
		name:   "TFTP_RRQ",
		rarity: 3,
		// Read request for "r7tftp.txt" - server responds with error
		// Format: [opcode=1][filename][null][mode][null]
		payload: []byte{
			0x00, 0x01, 0x72, 0x37, 0x74, 0x66, 0x74, 0x70, 0x2e, 0x74, 0x78, 0x74,
			0x00, 0x6f, 0x63, 0x74, 0x65, 0x74, 0x00,
		},
		ports: []int{69},
	},

	// Kerberos (88) - Network Authentication Protocol
	{
		name:   "Kerberos",
		rarity: 4,
		// AS-REQ message requesting a TGT for realm "NM"
		payload: []byte{
			0x6a, 0x81, 0x6e, 0x30, 0x81, 0x6b, 0xa1, 0x03, 0x02, 0x01, 0x05, 0xa2,
			0x03, 0x02, 0x01, 0x0a, 0xa4, 0x81, 0x5e, 0x30, 0x5c, 0xa0, 0x07, 0x03,
			0x05, 0x00, 0x50, 0x80, 0x00, 0x10, 0xa2, 0x04, 0x1b, 0x02, 0x4e, 0x4d,
			0xa3, 0x17, 0x30, 0x15, 0xa0, 0x03, 0x02, 0x01, 0x00, 0xa1, 0x0e, 0x30,
			0x0c, 0x1b, 0x06, 0x6b, 0x72, 0x62, 0x74, 0x67, 0x74, 0x1b, 0x02, 0x4e,
			0x4d, 0xa5, 0x11, 0x18, 0x0f, 0x31, 0x39, 0x37, 0x30, 0x30, 0x31, 0x30,
			0x31, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x5a, 0xa7, 0x06, 0x02, 0x04,
			0x1f, 0x1e, 0xb9, 0xd9, 0xa8, 0x17, 0x30, 0x15, 0x02, 0x01, 0x12, 0x02,
			0x01, 0x11, 0x02, 0x01, 0x10, 0x02, 0x01, 0x17, 0x02, 0x01, 0x01, 0x02,
			0x01, 0x03, 0x02, 0x01, 0x02,
		},
		ports: []int{88},
	},

	// RPC/Portmapper (111) - Sun RPC portmapper
	{
		name:   "RPCCheck",
		rarity: 4,
		// GETPORT call to query available RPC services
		payload: []byte{
			0x72, 0xfe, 0x1d, 0x13, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02,
			0x00, 0x01, 0x86, 0xa0, 0x00, 0x01, 0x97, 0x7c, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00,
		},
		ports: []int{111},
	},

	// NTP (123) - Network Time Protocol
	{
		name:   "NTPRequest",
		rarity: 1,
		// NTPv4 client request; servers respond with current time
		// Flags: 0xe3 = LI=3(unsync), VN=4, Mode=3(client)
		payload: []byte{
			0xe3, 0x00, 0x04, 0xfa, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0xc5, 0x4f, 0x23, 0x4b, 0x71, 0xb1, 0x52, 0xf3,
		},
		ports: []int{123},
	},

	// NetBIOS Name Service (137) - Windows networking
	{
		name:   "NBTStat",
		rarity: 2,
		// NBSTAT query for wildcard name "*" to enumerate names
		// CKAAA... is the NetBIOS encoded form of "*"
		payload: []byte{
			0x80, 0xf0, 0x00, 0x10, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x20, 0x43, 0x4b, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41,
			0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41,
			0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x00, 0x00, 0x21,
			0x00, 0x01,
		},
		ports: []int{137},
	},

	// SNMP (161) - Simple Network Management Protocol
	{
		name:   "SNMPv1public",
		rarity: 1,
		// GET with community "public", OID 1.3.6.1.2.1.1.5.0 (sysName)
		payload: []byte{
			0x30, 0x82, 0x00, 0x2f, 0x02, 0x01, 0x00, 0x04, 0x06, 0x70, 0x75, 0x62,
			0x6c, 0x69, 0x63, 0xa0, 0x82, 0x00, 0x20, 0x02, 0x04, 0x4c, 0x33, 0xa7,
			0x56, 0x02, 0x01, 0x00, 0x02, 0x01, 0x00, 0x30, 0x82, 0x00, 0x10, 0x30,
			0x82, 0x00, 0x0c, 0x06, 0x08, 0x2b, 0x06, 0x01, 0x02, 0x01, 0x01, 0x05,
			0x00, 0x05, 0x00,
		},
		ports: []int{161},
	},
	{
		name:   "SNMPv2c",
		rarity: 1,
		// SNMPv2c GET with community "public"
		payload: []byte{
			0x30, 0x26, 0x02, 0x01, 0x01, 0x04, 0x06, 0x70, 0x75, 0x62, 0x6c, 0x69,
			0x63, 0xa1, 0x19, 0x02, 0x04, 0xdc, 0x63, 0xc2, 0x9a, 0x02, 0x01, 0x00,
			0x02, 0x01, 0x00, 0x30, 0x0b, 0x30, 0x09, 0x06, 0x05, 0x2b, 0x06, 0x01,
			0x02, 0x01, 0x05, 0x00,
		},
		ports: []int{161},
	},
	{
		name:   "SNMPv3GetRequest",
		rarity: 2,
		// SNMPv3 GET request (works without auth on some devices)
		payload: []byte{
			0x30, 0x3a, 0x02, 0x01, 0x03, 0x30, 0x0f, 0x02, 0x02, 0x4a, 0x69, 0x02,
			0x03, 0x00, 0xff, 0xe3, 0x04, 0x01, 0x04, 0x02, 0x01, 0x03, 0x04, 0x10,
			0x30, 0x0e, 0x04, 0x00, 0x02, 0x01, 0x00, 0x02, 0x01, 0x00, 0x04, 0x00,
			0x04, 0x00, 0x04, 0x00, 0x30, 0x12, 0x04, 0x00, 0x04, 0x00, 0xa0, 0x0c,
			0x02, 0x02, 0x37, 0xf0, 0x02, 0x01, 0x00, 0x02, 0x01, 0x00, 0x30, 0x00,
		},
		ports: []int{161},
	},

	// XDMCP (177) - X Display Manager Control Protocol
	{
		name:   "XDMCP",
		rarity: 5,
		// QUERY message to discover X display managers
		// Version 1, opcode QUERY (2), auth names length 0
		payload: []byte{0x00, 0x01, 0x00, 0x02, 0x00, 0x01, 0x00},
		ports:   []int{177},
	},

	// LDAP (389) - Lightweight Directory Access Protocol (CLDAP)
	{
		name:   "LDAPSearchReqUDP",
		rarity: 3,
		// SearchRequest with base "", scope 0, filter objectClass
		payload: []byte{
			0x30, 0x84, 0x00, 0x00, 0x00, 0x2d, 0x02, 0x01, 0x07, 0x63, 0x84, 0x00,
			0x00, 0x00, 0x24, 0x04, 0x00, 0x0a, 0x01, 0x00, 0x0a, 0x01, 0x00, 0x02,
			0x01, 0x00, 0x02, 0x01, 0x64, 0x01, 0x01, 0x00, 0x87, 0x0b, 0x6f, 0x62,
			0x6a, 0x65, 0x63, 0x74, 0x43, 0x6c, 0x61, 0x73, 0x73, 0x30, 0x84, 0x00,
			0x00, 0x00, 0x00,
		},
		ports: []int{389},
	},

	// SLP (427) - Service Location Protocol
	{
		name:   "SLP",
		rarity: 4,
		// SLPv2 SrvRqst for service:service-agent in "default" scope
		payload: []byte{
			0x02, 0x01, 0x00, 0x00, 0x36, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
			0x00, 0x02, 0x65, 0x6e, 0x00, 0x00, 0x00, 0x15, 0x73, 0x65, 0x72, 0x76,
			0x69, 0x63, 0x65, 0x3a, 0x73, 0x65, 0x72, 0x76, 0x69, 0x63, 0x65, 0x2d,
			0x61, 0x67, 0x65, 0x6e, 0x74, 0x00, 0x07, 0x64, 0x65, 0x66, 0x61, 0x75,
			0x6c, 0x74, 0x00, 0x00, 0x00, 0x00,
		},
		ports: []int{427},
	},

	// IKE/ISAKMP (500) - Internet Key Exchange
	{
		name:   "IKE",
		rarity: 4,
		// Main mode initiator with 4 transform proposals
		// Initiator cookie: 0x0011223344556677
		payload: []byte{
			0x00, 0x11, 0x22, 0x33, 0x44, 0x55, 0x66, 0x77, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x01, 0x10, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x00, 0xa4, 0x00, 0x00, 0x00, 0x01,
			0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x98, 0x01, 0x01, 0x00, 0x04,
			0x03, 0x00, 0x00, 0x24, 0x01, 0x01, 0x00, 0x00, 0x80, 0x01, 0x00, 0x05,
			0x80, 0x02, 0x00, 0x02, 0x80, 0x03, 0x00, 0x01, 0x80, 0x04, 0x00, 0x02,
			0x80, 0x0b, 0x00, 0x01, 0x00, 0x0c, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01,
			0x03, 0x00, 0x00, 0x24, 0x02, 0x01, 0x00, 0x00, 0x80, 0x01, 0x00, 0x05,
			0x80, 0x02, 0x00, 0x01, 0x80, 0x03, 0x00, 0x01, 0x80, 0x04, 0x00, 0x02,
			0x80, 0x0b, 0x00, 0x01, 0x00, 0x0c, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01,
			0x03, 0x00, 0x00, 0x24, 0x03, 0x01, 0x00, 0x00, 0x80, 0x01, 0x00, 0x01,
			0x80, 0x02, 0x00, 0x02, 0x80, 0x03, 0x00, 0x01, 0x80, 0x04, 0x00, 0x02,
			0x80, 0x0b, 0x00, 0x01, 0x00, 0x0c, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01,
			0x00, 0x00, 0x00, 0x24, 0x04, 0x01, 0x00, 0x00, 0x80, 0x01, 0x00, 0x01,
			0x80, 0x02, 0x00, 0x01, 0x80, 0x03, 0x00, 0x01, 0x80, 0x04, 0x00, 0x02,
			0x80, 0x0b, 0x00, 0x01, 0x00, 0x0c, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01,
		},
		ports: []int{500},
	},

	// IPMI/RMCP (623) - Intelligent Platform Management Interface
	{
		name:   "IPMI-RMCP",
		rarity: 3,
		// Get Channel Auth Capabilities request
		// Used for BMC, iLO, iDRAC, etc.
		payload: []byte{
			0x06, 0x00, 0xff, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x09, 0x20, 0x18, 0xc8, 0x81, 0x00, 0x38, 0x8e, 0x04, 0xb5,
		},
		ports: []int{623},
	},
	{
		name:   "RMCP-ASF-Ping",
		rarity: 4,
		// Simpler RMCP ping, also works for IPMI detection
		payload: []byte{
			0x06, 0x00, 0xff, 0x06, 0x00, 0x00, 0x11, 0xbe, 0x80, 0x00, 0x00, 0x00,
		},
		ports: []int{623},
	},

	// OpenVPN (1194) - OpenVPN VPN service
	{
		name:   "OpenVPN",
		rarity: 3,
		// OpenVPN P_CONTROL_HARD_RESET_CLIENT_V2 packet
		payload: []byte{
			0x38, 0x4c, 0x12, 0x9c, 0x0c, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00,
			0x00, 0x00,
		},
		ports: []int{1194},
	},

	// MS-SQL Browser (1434) - Microsoft SQL Server discovery
	{
		name:   "SQLPing",
		rarity: 2,
		// Single byte 0x02 requests instance enumeration
		payload: []byte{0x02},
		ports:   []int{1434},
	},

	// Citrix (1604) - Citrix ICA Browser
	{
		name:   "Citrix",
		rarity: 5,
		// Service discovery request for Citrix servers
		payload: []byte{
			0x1e, 0x00, 0x01, 0x30, 0x02, 0xfd, 0xa8, 0xe3, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		},
		ports: []int{1604},
	},

	// SSDP (1900) - Simple Service Discovery Protocol (UPnP)
	{
		name:   "SSDP-MSEARCH",
		rarity: 1,
		// M-SEARCH request to discover UPnP devices
		payload: []byte("M-SEARCH * HTTP/1.1\r\n" +
			"Host: 239.255.255.250:1900\r\n" +
			"Man: \"ssdp:discover\"\r\n" +
			"MX: 5\r\n" +
			"ST: ssdp:all\r\n" +
			"\r\n"),
		ports: []int{1900},
	},

	// NFS (2049) - Network File System
	{
		name:   "NFS-NULL",
		rarity: 4,
		// NULL RPC call to check if NFS service is available
		payload: []byte{
			0x3e, 0xec, 0xe3, 0xca, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02,
			0x00, 0xbc, 0x61, 0x4e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00,
		},
		ports: []int{2049},
	},

	// SIP (5060) - Session Initiation Protocol (VoIP)
	{
		name:   "SIPOptions",
		rarity: 2,
		// OPTIONS request to query server capabilities
		payload: []byte("OPTIONS sip:nm SIP/2.0\r\n" +
			"Via: SIP/2.0/UDP nm;branch=foo;rport\r\n" +
			"From: <sip:nm@nm>;tag=root\r\n" +
			"To: <sip:nm2@nm2>\r\n" +
			"Call-ID: 50000\r\n" +
			"CSeq: 42 OPTIONS\r\n" +
			"Max-Forwards: 70\r\n" +
			"Content-Length: 0\r\n" +
			"Contact: <sip:nm@nm>\r\n" +
			"Accept: application/sdp\r\n" +
			"\r\n"),
		ports: []int{5060},
	},

	// mDNS (5353) - Multicast DNS (Bonjour/Avahi)
	{
		name:   "DNS-SD",
		rarity: 2,
		// Query for _services._dns-sd._udp.local PTR record
		payload: []byte{
			0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x09, 0x5f, 0x73, 0x65, 0x72, 0x76, 0x69, 0x63, 0x65, 0x73, 0x07, 0x5f,
			0x64, 0x6e, 0x73, 0x2d, 0x73, 0x64, 0x04, 0x5f, 0x75, 0x64, 0x70, 0x05,
			0x6c, 0x6f, 0x63, 0x61, 0x6c, 0x00, 0x00, 0x0c, 0x00, 0x01,
		},
		ports: []int{5353},
	},

	// DTLS (5246) - Datagram Transport Layer Security
	{
		name:   "DTLS-ClientHello",
		rarity: 4,
		// DTLS 1.2 ClientHello handshake
		payload: []byte{
			0x01, 0x00, 0x00, 0x00, 0x16, 0xfe, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x38, 0x01, 0x00, 0x00, 0x2c, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x2c, 0xfe, 0xff, 0x54, 0xcf, 0x1a, 0xe9, 0xa3, 0xb8,
			0x69, 0x96, 0x63, 0x47, 0x3b, 0x02, 0xfa, 0xf8, 0x96, 0xa4, 0x02, 0x49,
			0x1c, 0xf2, 0x2e, 0x08, 0x46, 0x4b, 0x34, 0x3f, 0xb1, 0x69, 0xb0, 0x3d,
			0x56, 0x76, 0x00, 0x00, 0x00, 0x04, 0x00, 0x2f, 0x00, 0x0a, 0x01, 0x00,
		},
		ports: []int{5246, 443, 4433},
	},

	// pcAnywhere (5632) - Symantec pcAnywhere remote access
	{
		name:   "pcAnywhere",
		rarity: 6,
		// "NQST" = Name Query Status (legacy remote desktop software)
		payload: []byte{0x4e, 0x51, 0x53, 0x54},
		ports:   []int{5632},
	},

	// Memcached (11211) - Distributed memory caching
	{
		name:   "Memcached",
		rarity: 3,
		// Binary protocol stats request
		payload: []byte{
			0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x73, 0x74, 0x61, 0x74,
			0x73, 0x0d, 0x0a,
		},
		ports: []int{11211},
	},
}

// LoadEmbeddedProbes creates a ProbeDB from the embedded probes.
// Probes are indexed by port for O(1) lookup during scanning.
// After loading, probes are sorted by rarity (lowest = tried first).
func LoadEmbeddedProbes() *ProbeDB {
	db := NewProbeDB()
	for _, ep := range embeddedProbes {
		probe := &Probe{
			Name:    ep.name,
			Payload: string(ep.payload),
			Rarity:  ep.rarity,
		}
		db.AddProbe(probe, ep.ports...)
	}
	db.SortProbes()
	return db
}
